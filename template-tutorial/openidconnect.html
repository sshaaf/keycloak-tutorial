<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Untitled :: Keycloak workshop</title>
    <link rel="canonical" href="https://redhat-scholars.github.io/course-template/template-tutorial/openidconnect.html">
    <link rel="prev" href="firstapp.html#firstapp">
    <link rel="next" href="usergroups.html#usergroups">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../_/img/NewRHDFullLogo_4-color_white-wordmark.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://redhat-scholars.github.io/course-template">Keycloak workshop</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="template-tutorial" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="settingup.html">Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="settingup.html#prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="settingup.html#wsenvironment">Environment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="settingup.html#idesetup">Setting up your IDE</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="keycloak.html#RH-SSO">Red Hat Single Sign-On</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="keycloak.html#ocptemplates">Openshift templates</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="keycloak.html#ssoinstall">SSO Installation</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="configuration.html#server-setup">Server Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="configuration.html#what-is-realm">What is a realm</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="configuration.html#master-realm">Master realm</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="configuration.html#email-integration">Email integration</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="firstapp.html#firstapp">Secure your first app</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="firstapp.html#openshift-architecture">OpenShift architecture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="firstapp.html#openshift-primitives">Primitives</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="firstapp.html#openshift-pod">Pod</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="firstapp.html#openshift-labels">Labels and selectors</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="firstapp.html#openshift-controller">Replication controller</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="firstapp.html#openshift-builds">Builds and images</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="firstapp.html#openshift-services">Services</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="firstapp.html#openshift-routes">Routes</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="firstapp.html#firstapp-project">Project and deployment</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="firstapp.html#firstapp-authentication">Authentication</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="firstapp.html#firstapp-deployment">Deployment</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#openid-connect">Open ID Connect</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#openid-saml-comparison">OIDC and SAML</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#openid-accesstokens">Access tokens</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#openid-idtokens">ID tokens</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#openid-claims">Claims</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#openid-client-scopes">Client scopes</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#openid-consent">Consent</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="usergroups.html#usergroups">Users and groups</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="usergroups.html#create-role">Create role</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="usergroups.html#create-group">Create group</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="usergroups.html#user-federation">User federation</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="identityproviders.html#identity-providers">Identity providers</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="identityproviders.html#oauth-oauth2">OAUTH and OAUTH2</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="identityproviders.html#github-integration">Users from Github</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="advanceconfig.html#advance-config">More customization</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="advanceconfig.html#keys-signing">Keys and signing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="advanceconfig.html#sessions">Sessions</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="advanceconfig.html#events">Events</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="advanceconfig.html#custom-code">Custom code and flows</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="advanceconfig.html#add-custom-code">Add custom code</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="advanceconfig.html#custom-stream">Create stream</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="advanceconfig.html#deploy-js-app">Re-deploy App</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="advanceconfig.html#configure-otp">Configuring OTP</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="advanceconfig.html#themes">Themes</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="conclusion.html">You made it!</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="appendix.html">Appendix</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Keyckoak workshop - Getting started</a></li>
    <li><a href="#openid-connect">Open ID Connect</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/sshaaf/keycloak-workshop/edit/master/documentation/modules/ROOT/pages/openidconnect.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<div id="openid-connect" class="paragraph">
<p>OpenID Connect (OIDC) is an authentication protocol that is an extension of OAuth 2.0. While OAuth 2.0 is only a framework for building authorization protocols and is mainly incomplete, OIDC is a full-fledged authentication and authorization protocol. OIDC also makes heavy use of the Json Web Token (JWT) set of standards. These standards define an identity token JSON format and ways to digitally sign and encrypt that data in a compact and web-friendly way.</p>
</div>
<div class="paragraph">
<p>There are really two types of use cases when using OIDC. The first is an application that asks the Red Hat SSO server to authenticate a user for them. After a successful login, the application will receive an identity token and an access token. The identity token contains information about the user such as username, email, and other profile information. The access token is digitally signed by the realm and contains access information (like user role mappings) that the application can use to determine what resources the user is allowed to access on the application.</p>
</div>
<div class="paragraph">
<p>The second type of use cases is that of a client that wants to gain access to remote services. In this case, the client asks Red Hat SSO to obtain an access token it can use to invoke on other remote services on behalf of the user. Red Hat SSO authenticates the user then asks the user for consent to grant access to the client requesting it. The client then receives the access token. This access token is digitally signed by the realm. The client can make REST invocations on remote services using this access token. The REST service extracts the access token, verifies the signature of the token, then decides based on access information within the token whether or not to process the request</p>
</div>
<div class="sect2">
<h3 id="openid-saml-comparison"><a class="anchor" href="#openid-saml-comparison"></a>Open ID Connect and SAML Comparision</h3>
<div class="paragraph">
<p>Choosing between OpenID Connect and SAML is not just a matter of using a newer protocol (OIDC) instead of the older more mature protocol (SAML).</p>
</div>
<div class="paragraph">
<p>In most cases OIDC is recommended. Beyond verbosity of exchanged data, if you compare the specifications you’ll find that OIDC was designed to work with the web while SAML was retrofitted to work on top of the web. For example, OIDC is also more suited for HTML5/JavaScript applications because it is easier to implement on the client side than SAML. As tokens are in the JSON format, they are easier to consume by JavaScript. You will also find several nice features that make implementing security in your web applications easier. For example, check out the iframe trick that the specification uses to easily determine if a user is still logged in or not.</p>
</div>
<div class="paragraph">
<p>SAML has its uses though. As you see the OIDC specifications evolve you see they implement more and more features that SAML has had for years. What we often see is that people pick SAML over OIDC because of the perception that it is more mature and also because they already have existing applications that are secured with it. Moreover quite alot of legacy applications are using SAML out there. Hence its important to note that Red Hat SSO also supports SAML</p>
</div>
</div>
<div class="sect2">
<h3 id="openid-accesstokens"><a class="anchor" href="#openid-accesstokens"></a>Access Tokens</h3>
<div class="paragraph">
<p>Access Tokens are used by an application to access an API. Access Tokens can be an opaque string, JWT, or non-JWT token. Its purpose is to inform the API that the bearer of this token has been granted delegated access to the API and request specific actions</p>
</div>
</div>
<div class="sect2">
<h3 id="openid-idtokens"><a class="anchor" href="#openid-idtokens"></a>ID Tokens</h3>
<div class="paragraph">
<p>The ID Token is a JWT (JSON Web Token) which contains user identity data e.g. user information like the user&#8217;s name, email etc, typically used for UI display. ID Tokens conform (IETF RFC 7519) and contain three parts: a header, a body and a signature. JWT Tokens also contain claims, which are statements (such as name or email address) about an entity (typically, the user) or additional metadata.</p>
</div>
</div>
<div class="sect1">
<h2 id="openid-claims"><a class="anchor" href="#openid-claims"></a>Adding claims to the tokens</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the previous section we created a Client and secured our app.</p>
</div>
<div class="sect2">
<h3 id="openid-client-scopes"><a class="anchor" href="#openid-client-scopes"></a>What are Client Scopes?</h3>
<div class="paragraph">
<p>If you have many applications you need to secure and register within your organization, it can become tedious to configure the protocol mappers and role scope mappings for each of these clients. Red Hat SSO allows you to define a shared client configuration in an entity called a client scope.</p>
</div>
<div class="paragraph">
<p>Client scopes also provide support for the OAuth 2 scope parameter, which allows a client application to request more or fewer claims or roles in the access token, according to the application needs.</p>
</div>
<div class="paragraph">
<p>The OpenID Connect specification defines a set of standard claims. The set of standard claims include name, email, gender, birth date, and so on. However, if you want to capture information about a user and there currently isn&#8217;t a standard claim that best reflects this piece of information, you can create custom claims and add them to your tokens.</p>
</div>
<div class="paragraph">
<p>What if your applications want to know something else about users? Say you want to have an avatar available for your users.</p>
</div>
<div class="paragraph">
<p>Red Hat SSO makes it possible to add custom attributes to users as well as adding custom claims to tokens.</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Ensure you are logged in as Admin</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Lets first open Users</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>And then View all users</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Select the user you registered with earlier, and not the Admin user.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Click on attributes and add key avatar_url with value <a href="https://www.keycloak.org/resources/images/keycloak_logo_200px.svg" class="bare">https://www.keycloak.org/resources/images/keycloak_logo_200px.svg</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Click Add followed by Save.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now Red Hat SSO knows the users avatar, but the application also needs access to this. We&#8217;re going to add this through Client Scopes.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Click on Client Scopes then Create.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Fill in the following values:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Name: avatar
Consent Screen Text: Avatar</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Click on Save.</p>
</li>
<li>
<p>Click on Mappers then Create.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Fill in the following values:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Name: avatar
Mapper Type: User Attribute
User Attribute avatar_url
Token Claim Name: avatar_url
Claim JSON Type: String</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Click Save.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Now we&#8217;ve created a client scope, but we also need to asign it to the client, so that our client 'js-console' can reflect the change as well.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Go to Clients and select js-console. Select Client Scopes.</p>
</li>
<li>
<p>We&#8217;re going to add it as a Default Client Scope. So select the avatar here and click 'Add selected'. As it&#8217;s a default scope it is added to the token by default, if it&#8217;s set as an optional client scope the client has to explicitly request it with the scope parameter.</p>
</li>
<li>
<p>Now go back to the JS Console and click Refresh. You should see a keycloak logo as your avatar on the main JS Console dashboard.</p>
</li>
<li>
<p>Click on <code>ID Token JSON</code> and <code>Access Token JSON</code> links and you can see the custom attribute added into the token as well.</p>
</li>
<li>
<p>Refresh your JS Console</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">"avatar_url": "https://www.keycloak.org/resources/images/keycloak_logo_200px.svg",</code></pre>
</div>
</div>
<div class="paragraph">
<p>And also on the front page of the JS Console</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/sso_jsconsoleuseravatar.png" alt="User Consent">
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="openid-consent"><a class="anchor" href="#openid-consent"></a>Requiring Consent</h2>
<div class="sectionbody">
<div class="paragraph">
<p>So far we&#8217;ve assumed the JS Console is an internal trusted application, but what if it&#8217;s a third party external application? In that case we probably want the user to grant access to what the application wants to have access to.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Open the Keycloak <code>Admin Console</code></p>
</li>
<li>
<p>Go to <code>Clients</code>, select JS Console and turn on Consent Required.</p>
</li>
<li>
<p>Press Save</p>
</li>
<li>
<p>Go back to the JS Console and click Login again.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Now you have successfully configured a consent. And you can see that it also shows the different attributes that you are consenting too.
You can grant consent and should then be able to see the grants. Lets move on to learn more about that.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/sso_adminuserconsent.png" alt="User Consent">
</div>
</div>
<div class="paragraph">
<p>Lets say if the user didnt want to consent any longer. They could goto to the accounts page and remove the consent.</p>
</div>
<div class="paragraph">
<p>Hit the account portal url e.g. &lt;SERVER_URL&gt;/auth/realms/demojs/account
e.g. <a href="https://sso-evals01-sso-kubernetes-workshop.apps.cph-5a34.open.redhat.com/auth/realms/demojs/account" class="bare">https://sso-evals01-sso-kubernetes-workshop.apps.cph-5a34.open.redhat.com/auth/realms/demojs/account</a></p>
</div>
<div class="paragraph">
<p>You can press the <code>Revoke Grant</code> and premissions will be removed.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/sso_useraccountrevoke.png" alt="Revoking grants">
</div>
</div>
<div class="paragraph">
<p>All the granted permissions and list of applictions will be listed. As you can see Account does not have a Consent, and hence does not offer the revoke options. This is very useful when multiple solutions an applications are connected to single sign on like Red Hat SSO.</p>
</div>
<div class="paragraph">
<p>You should turn this off again before continuing.</p>
</div>
<div class="paragraph">
<p>Congratulations you have completed this exercise.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>We have understood Open Id Connect</p>
</li>
<li>
<p>Comparision of SAML and OIDC</p>
</li>
<li>
<p>Configuring Client scopes, mappers and Grants.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Lets move on the next section and get into some more details.</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="firstapp.html#firstapp">Secure your first app</a></span>
  <span class="next"><a href="usergroups.html#usergroups">Users and groups</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
